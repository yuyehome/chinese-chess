《动态技术设计与交接文档》

这份文档是整个项目的技术核心，**必须在开发过程中持续维护**。

#### ** 1. 核心架构图**

codeMermaid

```
graph TD
    subgraph "表现层 (View)"
        InputController --"生成Command"--> CommandProcessor
        PieceView --"监听数据变化"--> GameState
        UIView --"监听数据/事件"--> GameState & EventBus
    end

    subgraph "逻辑层 (Logic)"
        CommandProcessor --"执行Command"--> GameModeManager
        GameModeManager --"调用具体规则"--> IGameModeLogic
        IGameModeLogic --"修改状态"--> GameState
    end

    subgraph "数据层 (Data)"
        GameState
    end

    subgraph "服务层 (Services)"
        EventBus
        INetworkService
        DataManager
    end

    CommandProcessor --"通过网络发送Command"--> INetworkService
```

（此图会随着架构细化而更新）

#### **2. 模块与代码结构**

**根目录结构**:

codeCode

```
/Assets
├── /_Core                 # 核心架构代码
│   ├── /Data
│   ├── /Command
│   └── ...
├── /_Gameplay             # 玩法模块代码
│   ├── /TurnBased
│   ├── /RealTime
│   └── ...
├── /_App                  # 外围应用系统代码
│   ├── /UI
│   ├── /Lobby
│   └── ...
├── /_Content              # 内容数据 (ScriptableObjects)
│   ├── /Heroes
│   ├── /Campaigns
│   └── ...
├── /Prefabs               # 预制体
├── /Scenes                # 场景
└── /... (其他Unity文件夹)
```

#### **3. 核心类与接口说明**

|   |   |   |   |
|---|---|---|---|
|类/接口名|所在模块|核心职责|关键方法/属性|
|GameState|Core.GameState|存储对局的唯一事实来源(Truth Source)。|List<PieceData> Pieces, float[] ActionPoints|
|ICommand|Core.Command|定义指令的接口，用于状态变更。|Execute(), Undo()|
|CommandProcessor|Core.Command|接收、验证、执行、分发指令。|ProcessCommand(ICommand cmd)|
|IGameModeLogic|Core.GameModes|定义游戏规则插件的接口。|ValidateCommand(ICommand cmd, GameState state)|
|INetworkService|Core.Networking|网络服务抽象接口。|SendToServer(ICommand cmd)|
|PieceView|Core.View|棋子GameObject的表现脚本。|OnGameStateUpdate(GameState state)|
|...|...|...|...|

(随着开发的进行，不断向此列表添加新的关键类)

#### **4. 重要决策记录 (Architecture Decision Records - ADR)**

- **ADR-001: 选用指令模式 (Command Pattern)**
    
    - **日期**: 2023-10-27
        
    - **决策**: 采用指令模式作为修改游戏状态的唯一途径。
        
    - **理由**: 便于网络同步、实现回放、撤销功能，并将逻辑与表现解耦。
        
    - **影响**: 所有游戏逻辑的实现都必须封装在Command类中，增加了少量前期开发成本，但大幅提升了系统可维护性和扩展性。
        
- **ADR-002: 网络同步方案**
    
    - **日期**: YYYY-MM-DD
        
    - **决策**: 使用Fish-Networking 4.x，主要同步ICommand对象，而非对象状态。客户端在收到服务器确认前回进行预测执行。
        
    - **理由**: 节省带宽，结构清晰，与指令模式天然契合。客户端预测可以减少操作延迟感。
        
    - **影响**: 需要为每个Command编写序列化逻辑。需要设计客户端预测与服务器状态校正的机制。
        

#### **5. 开发规范**

- **命名规范**: C#标准命名规范（类名PascalCase, 私有字段_camelCase...）。
    
- **代码注释**: 所有public方法和复杂逻辑块必须有XML注释。
    
- **Git工作流**: 采用Git Flow（main, develop, feature/, hotfix/）。所有feature分支必须通过Pull Request合并到develop，并至少需要一人Code Review。
    
- **...**