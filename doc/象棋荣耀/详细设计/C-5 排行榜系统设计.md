### **C-5排行榜系统设计前置共识 (L1)**

1. **地区榜实现 (客户端方案)**:
    
    - **放弃后端依赖**。地区榜完全在客户端实现。
        
    - 玩家在设置中**手动选择**地区（中国/全球）和省份，每次修改地区之后，下次至少30天之后才能修改。
        
    - 游戏将为每个地区/省份在Steam上创建独立的排行榜。例如：
        
        - Leaderboard_M3_ELO_Global_2025_S1
            
        - Leaderboard_M3_ELO_CN_2026_S4
            
        - Leaderboard_M3_ELO_CN_Guangdong_2025_S1
            
    - 玩家提交分数时，客户端根据玩家设置，向对应的排行榜提交。
        
        
2. **赛季制度实现 (客户端方案)**:
    
    - **基于现实日期**: 赛季更迭完全由客户端根据当前设备（PC）的**UTC日期**来判断。
        
    - **赛季划分**: 固定为每年4个赛季，每3个月一个。
        
    - **赛季结算**: 游戏启动时，会检查本地存档中记录的lastPlayedSeason。如果与当前日期计算出的currentSeason不符，则触发**赛季段位继承结算**，强制弹窗展示。
        
    - **段位继承**: 继承公式为每个赛季就打8折，例如玩家S1的数据，等到了S4再打开，段位就会X0.8X0.8X0.8 数据只有原来的 0.512倍。这个计算在客户端本地完成。
        
3. **榜单维度**:
        
    - **最终榜单维度**:
        
        - 模式 (3种): 传统回合制(M1), 实时公平(M2), 实时技能(M3)
            
        - 数据类型 (2种): 段位(ELO), 总胜场
            
        - 地区 (N种): 全球, 中国, 中国各省...
            
        - 赛季 (持续增加): S1, S2...
            
    - **总排行榜数量** = (3模式 * 2数据类型) * N地区 * M赛季。这是一个庞大的数量，但Steam支持。
        
4. **段位数据归属**:
    
    - 段位(ELO)分数是玩家的核心数据，属于PlayerProfile的一部分，由**App.Persistence (C-4.1)** 模块负责其**存储**。
        
    - 段位的**计算逻辑**，即对局结束后ELO如何变化，应该属于各个**游戏模式逻辑**的一部分。例如，RealTimeSkillLogic在判断游戏结束后，会负责计算双方的ELO增减。
        
    - **L1模块**（排行榜系统）的职责是**读取**计算和存储好的ELO分数，并将其**提交**到Steam。
        

---

### **详细设计文档: L1 - 排行榜系统**

**文档版本**: 1.0  
**设计目标**: 构建一个功能全面、支持地区筛选和自动赛季更迭的排行榜系统。该系统完全基于客户端逻辑和Steamworks API，无需自建后端服务器，并与现有的经济和持久化系统无缝集成。

---

### **第一部分：核心功能与逻辑说明 (Functional & Logic Specification)**

1. **多维度榜单**:
    
    - 系统支持按 **游戏模式(M1/M2/M3)**、**数据类型(段位/胜场)**、**地区(全球/中国/省份)** 和 **赛季** 四个维度进行组合查询。玩家可以在UI上自由切换这些筛选条件来查看不同的排行榜。
        
2. **地区自选**:
    
    - 玩家可在设置菜单中手动选择自己的地区和省份。此选择决定了玩家的分数会被提交到哪个地区榜单。为防止滥用，地区修改有30天的冷却时间，该冷却时间戳记录在玩家的本地加密存档中。
        
3. **客户端驱动的赛季**:
    
    - 赛季更迭不依赖服务器，完全由客户端根据设备当前的UTC日期计算得出。每年固定四个赛季。
        
    - 游戏启动时会自动检测赛季是否更替。如果检测到新赛季，会触发一次性的段位分数继承结算，并将上赛季的最终成绩记录下来以供展示。
        
4. **数据流**:
    
    - **段位(ELO)计算**: 在PVP对局结束后，由权威主机(Host)根据双方ELO差距和胜负结果，使用标准的ELO算法计算分数变化，并通过指令同步给双方。
        
    - **数据存储**: 变化后的ELO分数和累计胜场数被保存在各自玩家的PlayerProfile本地加密存档中。
        
    - **数据提交**: 在分数更新后，客户端会负责将新的分数提交到当前赛季和玩家所选地区对应的Steam排行榜上。
        

---

### **第二部分：技术架构与代码设计 (Technical & Code Design)**

### **模块 1: App.Persistence (PlayerProfile) (扩展)**

- **代码路径**: Assets/_App/Persistence/, Assets/_Core/Data/
    
- **PlayerProfile 结构体扩展**:
    
    - public int[] eloScores = new int[3];: 存储三个模式的段位分。索引0=M1, 1=M2, 2=M3。
        
    - public int[] totalWins = new int[3];: 存储三个模式的总胜场。
        
    - public string lastPlayedSeasonId;: 记录最后一次进行游戏时的赛季ID，如 "2024_S1"。
        
    - public string region_country;: 玩家选择的国家，如 "Global", "CN"。
        
    - public string region_province;: 玩家选择的省份，如 "Guangdong"。
        
    - public long lastRegionChangeTimestamp;: 上次修改地区的UTC时间戳。
        
- **段位系统 (EloSystem)**:
    
    - **类型**: static class
        
    - **路径**: Assets/_Gameplay/Rules/
        
    - **职责**: 提供段位分数的计算方法。胜/平/负，基础得分为 +100, 0 , -100，根据不同的段位有不同的额外表现分，根据对局情况得分有浮动，例如青铜段位额外200分，一局最多可能+300分（升三星）。青铜，白银，黄金，铂金，钻石，星耀，王者，对应的额外表现分最高分别是200，150，100，50，30，20，10。如果高段位输给低段位，额外扣分。
        

### **模块 2: App.Season - 赛季管理系统**

- **代码路径**: Assets/_App/Season/
    
- **SeasonManager**
    
    - **类型**: 单例
        
    - **职责**: 负责所有与赛季相关的逻辑，包括当前赛季计算和赛季更迭结算。
        
    - **关键方法**:
        
        - public string GetCurrentSeasonId():
            
            - 获取DateTime.UtcNow。
                
            - 根据月份计算出是第几季度 (1-3月=S1, 4-6月=S2 ...)。
                
            - 返回格式化的字符串，如 "2024_S2"。
                
        - public void CheckAndProcessSeasonRollover(PlayerProfile profile):
            
            - 在PlayerDataManager.LoadPlayerData()成功后调用。
                
            - currentSeason = GetCurrentSeasonId();
                
            - if (profile.lastPlayedSeasonId != null && profile.lastPlayedSeasonId != currentSeason):
                
                1. 触发赛季结算流程。
                    
                2. for (int i=0; i<3; i++) { profile.eloScores[i] = (int)(profile.eloScores[i] * 0.8f); }
                    
                3. 记录上赛季的最终成绩（可选，用于历史展示）。
                    
                4. 更新 profile.lastPlayedSeasonId = currentSeason;
                    
                5. PlayerDataManager.SavePlayerData();
                    
                6. 弹出一个UI面板，告知玩家新赛季开始及段位继承结果。
                    

### **模块 3: App.Leaderboard - 排行榜核心 (L1)**

- **代码路径**: Assets/_App/Leaderboard/
    
- **LeaderboardManager**
    
    - **类型**: 单例
        
    - **职责**: 封装所有与Steam排行榜API的交互，提供简单的查询和提交接口。
        
    - **关键方法**:
        
        - private string GetLeaderboardName(GameModeType mode, LeaderboardType type, string seasonId, string country, string province):
            
            - **核心辅助方法**。根据所有维度，拼接出对应Steam排行榜的唯一名称字符串。
                
            - 例如: M3_ELO_S1_CN_Guangdong
                
        - public void UploadScore(GameModeType mode, LeaderbordType type, int score):
            
            - 获取PlayerDataManager.Profile中的地区和赛季信息。
                
            - 调用GetLeaderboardName拼接出排行榜名称。
                
            - 调用Steamworks.NET的SteamUserStats.UploadLeaderboardScore(leaderboardName, score, ...)。
                
        - public async Task<List<LeaderboardEntry>> DownloadEntries(GameModeType mode, ...):
            
            - 异步方法，用于查询排行榜数据。
                
            - 内部同样拼接排行榜名称，然后调用SteamUserStats.DownloadLeaderboardEntries(...)。
                
            - 将返回的Steam原生数据格式，转换为我们自定义的、便于UI显示的LeaderboardEntry结构体。
                
- **LeaderboardPanel** (UI面板)
    
    - **职责**: 提供UI界面让玩家筛选和查看排行榜。
        
    - **控件**: 多个下拉框（模式、类型、地区、赛季），一个用于显示排名的列表。
        
    - **逻辑**: 当玩家改变筛选条件时，调用LeaderboardManager.DownloadEntries并用返回的数据刷新列表。
        

### **Unity工作流 (Unity Workflow)**

1. **Steamworks后台配置**:
    
    - 在游戏的Steamworks后台，我们需要**批量创建**大量的排行榜。可以先创建当前赛季的全球榜和中国各省的榜单。例如：
        
        - M1_ELO_S1_Global, M1_Wins_S1_Global
            
        - M1_ELO_S1_CN_Beijing, M1_Wins_S1_CN_Beijing
            
        - ...为每个模式、每个地区都创建好。
            
2. **游戏内流程**:
    
    - **对局结束**: 主机计算完ELO和胜场变化后，通过指令更新双方的PlayerProfile。
        
    - **数据保存**: PlayerDataManager保存数据。
        
    - **分数上传**: 在保存成功后，PlayerDataManager调用LeaderboardManager.UploadScore，将新的ELO分数和总胜场数提交到Steam。
        
    - **查看榜单**: 玩家在主菜单点击【排行榜】按钮，打开LeaderboardPanel，默认显示玩家当前段位最高的那个模式的排行榜。