### **《象棋荣耀》项目核心脚本技术文档**

**核心技术栈:** Unity, C#, FishNet v4.x, Steamworks.NET

#### **一、 总体架构思想**

本项目采用**服务器权威（Server-Authoritative）**架构。

- **服务器 (Server/Host):** 游戏状态的唯一“真相”来源。负责所有游戏逻辑计算（移动合法性、能量增减、战斗裁定）和状态同步。
    
- **客户端 (Client):** 主要负责**表现**和**输入**。接收服务器同步的数据来渲染游戏世界（如棋子位置、能量条），并将玩家的操作作为“请求”发送给服务器，等待服务器处理和广播结果。
    

---

#### **二、 核心脚本清单与职责**

- **SteamManager.cs**
    
    - **职责:** 底层服务。负责初始化Steamworks API，获取玩家的Steam昵称和ID。是所有Steam功能（如好友、大厅）的基础。全局单例，跨场景存在。
        
- **LobbyManager.cs**
    
    - **职责:** Steam大厅功能模块。处理所有与Steam Lobby相关的操作：创建、查找、加入、离开房间。负责启动FishNet网络连接（作为Host或Client），并在游戏场景加载完毕后，在服务器上生成网络化的管理器（GameManager, GameNetworkManager）。全局单例，跨场景存在。
        

- **MainMenuController.cs**
    
    - **职责:** 主菜单UI交互逻辑。处理所有按钮点击事件，如启动单机游戏、打开/关闭创建房间面板、更新大厅房间内的玩家信息UI等。
        
- **LobbyItem.cs**
    
    - **职责:** UI组件。挂载于大厅列表的Prefab上，用于显示单个房间的信息（名称、人数）并处理加入按钮的点击事件。
        

- **GameManager.cs (NetworkBehaviour)**
    
    - **职责:** **游戏逻辑的权威核心**。这是一个网络对象，在服务器上运行核心游戏循环 (Update)。
        
    - **状态管理:** 持有权威的能量值 (_redPlayerEnergy, _blackPlayerEnergy) 并通过 [SyncVar] 自动同步给客户端。持有权威的棋盘逻辑状态 (BoardState)。
        
    - **逻辑驱动:** 在服务器上驱动 EnergySystem 进行能量恢复，驱动 RealTimeModeController 进行战斗和移动状态更新。
        
    - **请求处理:** 提供 Server_ProcessMoveRequest 方法，作为处理客户端移动请求的入口。
        
- **GameNetworkManager.cs (NetworkBehaviour)**
    
    - **职责:** **网络通信的中心枢纽**。这是一个网络对象，负责管理玩家连接和RPC（远程过程调用）。
        
    - **玩家管理:** 处理玩家的注册请求 (CmdRegisterPlayer)，分配阵营颜色，并通过 TargetRpc 将玩家身份数据精确发回给对应客户端。
        
    - **RPC路由:** 提供 CmdRequestMove 方法，作为客户端发起移动请求的唯一网络入口，并将请求转发给 GameManager。
        
    - **对象生成:** 提供 Server_InitializeBoard 方法，在服务器上根据 BoardState 生成所有网络化的棋子。
        
- **GameSetupController.cs**
    
    - **职责:** **客户端本地环境的设置器**。
        
    - **PVP:** 监听网络事件，一旦接收到自己的玩家身份，立即为本地玩家创建并初始化输入控制器 (PlayerInputController)，并根据阵营调整相机视角。
        
    - **PVE:** 在单机模式下，负责创建玩家控制器 (PlayerInputController) 和AI控制器 (AIController)。
        
    - **一次性任务:** 完成初始化后即禁用自身。
        

- **EnergySystem.cs**
    
    - **职责:** **无状态的能量计算器**。提供纯函数，用于计算能量的恢复 (Tick) 和消耗 (SpendEnergy)。它本身不存储任何能量数据，所有数据都由 GameManager 传入。
        
- **BoardState.cs**
    
    - **职责:** **棋盘逻辑状态的数据模型**。用一个二维数组表示棋盘上所有**静止**棋子的位置和信息。提供查询、移动、移除棋子的接口。
        
- **RuleEngine.cs**
    
    - **职责:** **静态的中国象棋规则引擎**。提供纯静态方法 GetValidMoves，根据传入的棋子和棋盘状态，计算所有合法的移动点。不包含任何游戏流程或实时逻辑。
        
- **GameModeController.cs (及其子类)**
    
    - RealTimeModeController.cs: 实时模式的逻辑执行器。在服务器上管理所有移动中棋子的状态，并通过 CombatManager 处理碰撞和战斗裁定。
        
    - TurnBasedModeController.cs: (为未来保留) 回合制模式的逻辑执行器。
        
- **CombatManager.cs**
    
    - **职责:** 实时战斗裁决器。负责检测所有活动棋子之间的碰撞，根据状态（攻击、无敌）和阵营（敌方、友方）来判定伤害和击杀。
        

- **IPlayerController.cs**
    
    - **职责:** 接口。定义了所有“玩家”控制器（无论是真人、AI还是网络代理）都必须实现的初始化方法。
        
- **PlayerInputController.cs**
    
    - **职责:** 本地玩家输入处理器。负责将鼠标点击转换为游戏意图（选择棋子、请求移动），然后调用 GameNetworkManager 的RPC将请求发送到服务器。
        
- **AIController.cs**
    
    - **职责:** AI逻辑的驱动器。根据设定的 IAIStrategy (AI策略)，定时做出决策，并调用 GameManager 的 RequestMove 方法来执行移动。
        
- **IAIStrategy.cs (及其实现)**
    
    - EasyAIStrategy.cs, HardAIStrategy.cs, VeryHardAIStrategy.cs: 具体的AI决策逻辑，实现了不同难度的行为模式。
        

- **BoardRenderer.cs**
    
    - **职责:** **视觉渲染核心**。负责将逻辑棋盘状态 (BoardState) 转化为Unity场景中的3D对象。管理所有棋子GameObject的创建、销毁、移动动画和高亮效果。
        
- **PieceComponent.cs (NetworkBehaviour)**
    
    - **职责:** 挂载在棋子Prefab上的核心网络组件。
        
    - **数据同步:** 通过 SyncVar 同步棋子的基础身份（类型、颜色）。
        
    - **状态持有:** 持有棋子在实时模式下的动态状态 (RealTimePieceState)。
        
    - **动画触发:** 提供 Observer_PlayMoveAnimation RPC，由服务器调用，命令所有客户端播放此棋子的移动动画。
        
- **GameUIManager.cs**
    
    - **职责:** 游戏内UI管理器。负责创建和更新能量条、玩家信息等UI元素。通过 GameManager.Instance 获取最新的同步数据来刷新显示。
        
- **EnergyBarSegmentsUI.cs**
    
    - **职责:** UI组件。控制分段式能量条的具体视觉表现。